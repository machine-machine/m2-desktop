[supervisord]
nodaemon=true
user=root
logfile=/var/log/supervisord.log
pidfile=/var/run/supervisord.pid
childlogdir=/var/log

# =============================================================================
# D-Bus (required for desktop)
# =============================================================================
[program:dbus]
command=/usr/bin/dbus-daemon --system --nofork
user=root
autorestart=true
priority=5
stdout_logfile=/var/log/dbus.log
stderr_logfile=/var/log/dbus.err

# =============================================================================
# PulseAudio (for audio support)
# =============================================================================
[program:pulseaudio]
command=/usr/bin/pulseaudio --disallow-exit --disallow-module-loading --exit-idle-time=-1
user=developer
autorestart=true
priority=10
environment=HOME="/home/developer",XDG_RUNTIME_DIR="/tmp/runtime-developer"
stdout_logfile=/var/log/pulseaudio.log
stderr_logfile=/var/log/pulseaudio.err

# =============================================================================
# X11 Server (Xorg dummy) - REPLACES XVFB SECTION
# =============================================================================
[program:xorg]
# The command to run Xorg with the dummy driver using our config
command=/usr/bin/Xorg :0 -noreset +extension GLX +extension RANDR +extension RENDER -logfile /var/log/xorg.log -config /etc/X11/xorg.conf
user=root
autorestart=true
priority=15
# Xorg needs to run as root to set up the display, but we drop privileges for the session
stdout_logfile=/var/log/xorg.log
stderr_logfile=/var/log/xorg.err

# =============================================================================
# XFCE4 Desktop
# =============================================================================
[program:xfce4]
command=/usr/local/bin/start-desktop.sh
user=developer
autorestart=true
priority=20
startsecs=5
environment=HOME="/home/developer",USER="developer",DISPLAY=":0",XDG_RUNTIME_DIR="/tmp/runtime-developer"
stdout_logfile=/var/log/xfce4.log
stderr_logfile=/var/log/xfce4.err

# =============================================================================
# Selkies-GStreamer WebRTC Server
# =============================================================================
[program:selkies]
command=/bin/bash -c 'source /opt/gstreamer/gst-env && sleep 5 && TURN_ARGS=""; if [ -n "$TURN_HOST" ]; then TURN_TLS="false"; if [ "${TURN_PORT:-80}" = "443" ]; then TURN_TLS="true"; fi; TURN_ARGS="--turn_host=$TURN_HOST --turn_port=${TURN_PORT:-80} --turn_tls=$TURN_TLS --turn_username=$TURN_USERNAME --turn_password=$TURN_PASSWORD"; fi; selkies-gstreamer --addr=0.0.0.0 --port=8080 --enable_basic_auth=%(ENV_SELKIES_ENABLE_BASIC_AUTH)s --encoder=%(ENV_SELKIES_ENCODER)s --framerate=%(ENV_SELKIES_FRAMERATE)s $TURN_ARGS'
user=developer
autorestart=true
priority=30
startsecs=8
# GStreamer environment variables + Selkies config
environment=HOME="/home/developer",USER="developer",DISPLAY=":0",XDG_RUNTIME_DIR="/tmp/runtime-developer",PULSE_SERVER="unix:/tmp/runtime-developer/pulse/native",GSTREAMER_PATH="/opt/gstreamer",SELKIES_ENCODER="%(ENV_SELKIES_ENCODER)s",SELKIES_FRAMERATE="%(ENV_SELKIES_FRAMERATE)s",SELKIES_VIDEO_BITRATE="%(ENV_SELKIES_VIDEO_BITRATE)s",TURN_HOST="%(ENV_TURN_HOST)s",TURN_PORT="%(ENV_TURN_PORT)s",TURN_USERNAME="%(ENV_TURN_USERNAME)s",TURN_PASSWORD="%(ENV_TURN_PASSWORD)s"
stdout_logfile=/var/log/selkies.log
stderr_logfile=/var/log/selkies.err

# =============================================================================
# Clawdbot Gateway
# =============================================================================
[program:clawdbot-gateway]
command=/bin/bash -c 'sleep 10 && clawdbot gateway --port 18789 --allow-unconfigured'
user=developer
autorestart=true
priority=40
startsecs=5
environment=HOME="/home/developer",USER="developer",DISPLAY=":0",CLAWDBOT_HOME="/clawdbot_home",WORKSPACE="/workspace"
stdout_logfile=/var/log/clawdbot.log
stderr_logfile=/var/log/clawdbot.err
