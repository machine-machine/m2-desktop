# =============================================================================
# M2 Desktop - Supervisord Configuration (Guacamole Variant)
# x11vnc + guacd + guacamole-lite for multi-user HTML5 remote desktop
# =============================================================================

[supervisord]
nodaemon=true
user=root
logfile=/var/log/supervisord.log
pidfile=/var/run/supervisord.pid
childlogdir=/var/log

# =============================================================================
# D-Bus (required for desktop)
# =============================================================================
[program:dbus]
command=/usr/bin/dbus-daemon --system --nofork
user=root
autorestart=true
priority=5
stdout_logfile=/var/log/dbus.log
stderr_logfile=/var/log/dbus.err

# =============================================================================
# PulseAudio (for audio support)
# =============================================================================
[program:pulseaudio]
command=/usr/bin/pulseaudio --disallow-exit --disallow-module-loading --exit-idle-time=-1
user=developer
autorestart=true
priority=10
environment=HOME="/home/developer",XDG_RUNTIME_DIR="/tmp/runtime-developer"
stdout_logfile=/var/log/pulseaudio.log
stderr_logfile=/var/log/pulseaudio.err

# =============================================================================
# X11 Server (Xorg dummy)
# =============================================================================
[program:xorg]
command=/usr/bin/Xorg :0 -noreset +extension GLX +extension RANDR +extension RENDER -logfile /var/log/xorg.log -config /etc/X11/xorg.conf
user=root
autorestart=true
priority=15
stdout_logfile=/var/log/xorg.log
stderr_logfile=/var/log/xorg.err

# =============================================================================
# XFCE4 Desktop
# =============================================================================
[program:xfce4]
command=/usr/local/bin/start-desktop.sh
user=developer
autorestart=true
priority=20
startsecs=5
environment=HOME="/home/developer",USER="developer",DISPLAY=":0",XDG_RUNTIME_DIR="/tmp/runtime-developer"
stdout_logfile=/var/log/xfce4.log
stderr_logfile=/var/log/xfce4.err

# =============================================================================
# x11vnc (shares X11 display over VNC for Guacamole)
# =============================================================================
[program:x11vnc]
command=/bin/bash -c 'sleep 8 && x11vnc -display :0 -forever -shared -rfbport 5900 -rfbauth /tmp/.vnc_passwd -noxdamage -noxfixes -repeat -ncache 10 -ncache_cr'
user=root
autorestart=true
priority=25
startsecs=10
environment=DISPLAY=":0"
stdout_logfile=/var/log/x11vnc.log
stderr_logfile=/var/log/x11vnc.err

# =============================================================================
# guacd (Guacamole Protocol Daemon)
# =============================================================================
[program:guacd]
command=/usr/local/sbin/guacd -f -b 0.0.0.0 -l 4822
user=root
autorestart=true
priority=28
startsecs=3
stdout_logfile=/var/log/guacd.log
stderr_logfile=/var/log/guacd.err

# =============================================================================
# Guacamole-Lite Web Server (HTML5 client)
# =============================================================================
[program:guacamole]
command=/bin/bash -c 'sleep 12 && cd /opt/guacamole-lite && node server.js'
user=developer
autorestart=true
priority=30
startsecs=15
environment=HOME="/home/developer",USER="developer",DISPLAY=":0",XDG_RUNTIME_DIR="/tmp/runtime-developer",PULSE_SERVER="unix:/tmp/runtime-developer/pulse/native",GUAC_PORT="8080",VNC_PASSWORD="%(ENV_VNC_PASSWORD)s",GUAC_AUTH_PASSWORD="%(ENV_VNC_PASSWORD)s"
stdout_logfile=/var/log/guacamole.log
stderr_logfile=/var/log/guacamole.err

# =============================================================================
# M2 Gateway (AI Agent Interface)
# =============================================================================
[program:m2-gateway]
command=/bin/bash -c 'sleep 10 && clawdbot gateway --port 18789 --allow-unconfigured'
user=developer
autorestart=true
priority=40
startsecs=5
environment=HOME="/home/developer",USER="developer",DISPLAY=":0",M2_HOME="/m2_home",WORKSPACE="/workspace"
stdout_logfile=/var/log/m2-gateway.log
stderr_logfile=/var/log/m2-gateway.err
