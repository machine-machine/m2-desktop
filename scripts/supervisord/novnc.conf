# =============================================================================
# M2 Desktop - Supervisord Configuration (noVNC Variant)
# TigerVNC + websockify + noVNC for HTML5 remote desktop
# =============================================================================

[supervisord]
nodaemon=true
user=root
logfile=/var/log/supervisord.log
pidfile=/var/run/supervisord.pid
childlogdir=/var/log

# =============================================================================
# D-Bus (required for desktop)
# =============================================================================
[program:dbus]
command=/usr/bin/dbus-daemon --system --nofork
user=root
autorestart=true
priority=5
stdout_logfile=/var/log/dbus.log
stderr_logfile=/var/log/dbus.err

# =============================================================================
# PulseAudio (for audio support)
# =============================================================================
[program:pulseaudio]
command=/usr/bin/pulseaudio --disallow-exit --disallow-module-loading --exit-idle-time=-1
user=developer
autorestart=true
priority=10
environment=HOME="/home/developer",XDG_RUNTIME_DIR="/tmp/runtime-developer"
stdout_logfile=/var/log/pulseaudio.log
stderr_logfile=/var/log/pulseaudio.err

# =============================================================================
# TigerVNC Server (creates its own X display :1)
# =============================================================================
[program:vncserver]
command=/bin/bash -c 'rm -f /tmp/.X1-lock /tmp/.X11-unix/X1 && vncserver :1 -geometry 1920x1080 -depth 24 -fg -xstartup /usr/local/bin/start-desktop.sh'
user=developer
autorestart=true
priority=15
startsecs=5
environment=HOME="/home/developer",USER="developer",DISPLAY=":1",XDG_RUNTIME_DIR="/tmp/runtime-developer"
stdout_logfile=/var/log/vncserver.log
stderr_logfile=/var/log/vncserver.err

# =============================================================================
# noVNC (websockify proxy for HTML5 access)
# =============================================================================
[program:novnc]
command=/bin/bash -c 'sleep 5 && websockify --web=/usr/share/novnc 6080 localhost:5901'
user=developer
autorestart=true
priority=30
startsecs=8
environment=HOME="/home/developer"
stdout_logfile=/var/log/novnc.log
stderr_logfile=/var/log/novnc.err

# =============================================================================
# M2 Gateway (AI Agent Interface)
# =============================================================================
[program:m2-gateway]
command=/bin/bash -c 'sleep 10 && clawdbot gateway --port 18789 --allow-unconfigured'
user=developer
autorestart=true
priority=40
startsecs=5
environment=HOME="/home/developer",USER="developer",DISPLAY=":1",M2_HOME="/m2_home",WORKSPACE="/workspace"
stdout_logfile=/var/log/m2-gateway.log
stderr_logfile=/var/log/m2-gateway.err
